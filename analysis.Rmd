---
title: "RSI reversal notebook"
author: "Fernando Munoz"
output:
  html_notebook:
    highlight: default
    fig_retina: 2
    code_folding: show
    number_sections: no
    theme: flatly
    toc: yes
    toc_float: yes
---


```{r init stuff, message=FALSE, warning=FALSE, include=FALSE}

## Required packages
source("./configuration/requirements.R")

## Functions needed
source("./R/functions.R")


## Project settings
source("./Configuration/project_settings.R")
```

##Intro
This notebook reverses the data from the RSIs. For that we need to divides= it by userclas (business, commuting, other, (maybe more as it matches up with the tempro data) LGV, HGV) and Time Period. 

The trip purpose can be obtained from a combination of origin purpose and destination purpose.

## Data
Tempro data set probability table
RSI table from excel (pre-process to be done)

### Import the data
```{r}
df <- as.tibble(fread("./data/RSI_data.csv"))
```

We can see the different vehicle types in the plot below, as expected car is the biggest. LGV and HGV are quite small due to just having 1 day of data. Its then apparent than this data is probably not representative of the freight movements in the area as the variation of such a small sample would be too high.
```{r}
df %>%
  filter(str_detect(RSI_Site,pattern = "StNeots"))%>%
  group_by(Vehicle_Type)%>%
  summarise(total = n())%>%
  arrange(desc(total))%>%
  ggplot(aes(x= Vehicle_Type,y= total, fill=Vehicle_Type)) + geom_bar(stat = "identity") +geom_text(aes(label=total), vjust=-0.2)+ theme_bw()
```


We can see that there are 21 different combinations of HB trips (starting from home) but NTS data only contemplates 18 different purposes from which only 8 are HBased. Therefore a correspondence table will be created in Excel.
```{r}
unique(df[
  (df$Origin_Purpose == "HOME"),
  c("Origin_Purpose","Destination_Purpose")])
```
### Match up the trip Purposes
```{r}
#Write the table to csv in outputs
fwrite(unique(df[
  (df$Origin_Purpose == "HOME"),
  c("Origin_Purpose","Destination_Purpose")]), "./data/HB_purposes_RSI.csv")
```

The results of the match up are:

```{r}
HB_key <- as.tibble(fread("./data/HB_purposes_RSI_correspondence.csv")) 
HB_key
```

The tempro table is

```{r}
as.tibble(fread("./data/tblLookUpTripPurpose.csv")) 
```

The opposite trips have the same purposes but reversed:
```{r}
unique(df[
  (df$Destination_Purpose == "HOME"),
  c("Origin_Purpose","Destination_Purpose")])
```

### Match up the time periods

Our data has 3 time periods AM, IP, PM this is equivalent with TEMPRO's time periods 1,2,3 so a match up is not needed.

We create an hour column in the data by spliting the time column on the ":" we can see the last two columns have our created data

```{r}
df$hour <-  as.numeric(str_split_fixed(df$Time,pattern = ":", 2)[,1])
df$TP <- ConvertHourtoTP(df$hour)
```


### Filtering data

We have a set of different RSIs in different locations but we want only the ones that are in St Neots
```{r}
unique(df$RSI_Site)
```

```{r}
df <- df %>%
  filter(str_detect(RSI_Site,pattern = "StNeots"))
```

We also remove non homebased and freight into separate data frames as we are going to process them differently.

```{r}
dfHomeBound <- df[df$Destination_Purpose == "HOME",]
dfNHB <- df[df$Destination_Purpose != "HOME" & df$Origin_Purpose != "HOME",]

df <- df[df$Origin_Purpose == "HOME",]

```


To this data base we can `join` the trip purpose:

```{r}
df <- df %>%
  left_join(HB_key, by = c("Origin_Purpose","Destination_Purpose"))

df
```

### Read the tempro data

```{r}
phi <-  as.tibble(fread("./data/tblTripProbabilities.csv")) 
phi <- phi[phi$PHI>0,] # Remove 0 values

```

In this table the O denotes Origin and R return, H is the purpose and D is the time period. 
We filter the data to remove unused timeperiods. Phi is the probability that, given a initial TP and Purpose you return in another purpose or TP.

```{r}
phi <- phi %>%
  filter(DR %in% c(1:3) & DO %in% c(1:3))

phi
```

## Homebase OutBound trips

Finally we join the data for the outbound trips

For the analysis we keep only car, we have very few LGV or PSV to be of any use. We are basing a whole matrix in very little data.
```{r}
df %>%
  group_by(Vehicle_Type) %>%
  summarise(count = n())

```

```{r}
df <- df%>%
  filter(Vehicle_Type == "CAR")
```

### Adding the expansion factors from VS analysis

The RSI data was matched to some observed data by Victoria S and that information was used as expansion factors for the RSI that way we get the RSI data and put it in 2015 values.

Instead of applying the previous factors calculated by Victoria we are going to expand the matrix only on the outbound trips. The reason is that we are going to recalculate the inbound trips from those almost doubling them up. 
The resulting analysis is contained in `St Neots RSI_v3.xlsx` and a table is extracted as a csv and copied to data.

```{r}
expFactors <- as.tibble(fread("./data/RSI_expansion_factors"))

df <- df %>% 
  left_join(expFactors, by = c("RSI_Site" = "Site"))

```



### Joining the return probability

`dfReturn` contains the data we need to compute the return 
```{r}
dfReturn <- df %>%
  left_join(phi, by = c( "PurposeID" = "HO", "TP" = "DO"))

dfReturn$PHI = dfReturn$PHI * dfReturn$Factor #the trips are now expanded

dfReturn$Factor <- NULL
```

## Creating the full matrix

The information we want is in the format
TP, Bcat_O, Bcat_D, PurposeID, Vehs. 

```{r}
IBmat <- dfReturn %>%
  group_by(HR,DR,BlackcatOrig,BlackCatDest) %>%
  summarise(Trips = sum(PHI)) %>% ungroup()

IBmat <- IBmat %>% select(DR,BlackCatDest,BlackcatOrig,HR,Trips) # Reversing the order of the OD
```

The return matrix contains a total of `r sum(IBmat$Trips)` trips while the outbound matrix contains `r nrow(df)` as we can see there are more trips in the outbound homebased. 

```{r}
OBmat <- df %>%
  group_by(TP,BlackcatOrig,BlackCatDest,PurposeID)%>%
    summarise(trips = sum(Factor)) %>% ungroup()

names(IBmat) <- names(OBmat)
```


### Compare Inbound and Outbound

To ease the comparison we are going to add to the matrices the typical 3 car user classes EB, HBW, HBO using the purpose <-> UC correspondence file in the data folder.

```{r}
PID_UC <- as.tibble(fread("./data/purposes_RSI_UC_correspondance.csv"))
PID_UC
```

```{r}
OBmat$Bound <- "Out"
IBmat$Bound <- "In"

HBmat <- rbind(OBmat,IBmat)

HBmat %>%
  left_join(PID_UC, by = "PurposeID")%>%
  group_by(UC,Bound)%>%
  summarise(trips = sum(trips))%>%
  ggplot(aes(x= Bound, y= trips, label = round(trips),fill = as.factor(UC))) +
  geom_bar(stat = "identity")+
  geom_text( position = position_stack(vjust = 0.5))+
  ylab("Trips")+ labs(fill='UC')+theme_bw() 


HBmat %>%
  left_join(PID_UC, by = "PurposeID")%>%
  group_by(UC,TP,Bound)%>%
  summarise(trips = sum(trips))%>%
  ggplot(aes(x= TP, y= trips, label = round(trips),fill = as.factor(UC))) +
  geom_bar(stat = "identity")+
  geom_text( position = position_stack(vjust = 0.5))+
  facet_wrap(~Bound)+
  ylab("Trips")+ labs(fill='UC')+theme_bw()+
  ggtitle("RSI matrix reversal of Out by UC and TP")

ggsave("./figs/reversal_outbound_HO.pdf",  units = "cm", height = 14.8, width = 21)
```

The calculated Inbound trips are less than the original Outbound, about 87% of the original matrix
```{r}
sum(HBmat[HBmat$Bound == "In" ,]$trips)/
sum(HBmat[HBmat$Bound == "Out",]$trips)

sum(HBmat$trips)

```



## Calculation of Home Bound trips

## Obtaining reverse probablity
Home bound trips don't have a probablity calculated but we can compute it from the current data without much issue. `AssPrep_RetHomeFactors_Phi_2.xlsx`, used in a cube process, via means of a pivot table the phi probablity is reversed. Unfortunately only 3 purposes are anilsed and we want to expand that to the 8 purposes for increased accuracy. Also the validity of this calculations are not very apparent and there seems to be a mistake with the data used. Therefore Bayes's Rule, the conditional statistics on TEMPRO and the data we already have.

$$P(HO_A\mid HR_B)={\frac {P(HR_B\mid HO_A)\,P(HO_A)}{P(HR_B)}}$$

Calculation of the HO probabilities $P(HO_A)$ for each purpose using observed data:

```{r}
PO <- OBmat %>%
  group_by(PurposeID,TP) %>%
  summarise(sum = sum(trips))

PO$total <- sum(PO$sum)

PO$prob <- PO$sum/PO$total

PO
```

To Calculate P(B) we need to summarise P(B|A)

```{r}
pb_a <- phi %>%
  left_join(PO[,c(1,2,5)], by = c("HO" = "PurposeID", "DO" = "TP"))

pb_a[is.na(pb_a$prob),]$prob <- 0

pb_a$pb.by.pa = pb_a$PHI * pb_a$prob

PR <- pb_a %>% 
  group_by(HR,DR) %>%
  summarise(pbsum = sum(pb.by.pa))%>% ungroup()

PR
```

Now we have all the info we need to compute the return probablity P(A|B)


```{r}
pb_a <- pb_a %>%
  left_join(PR, by = c("HR", "DR"))

pb_a
```

```{r}
pb_a$pa.cond.b <- pb_a$pb.by.pa / pb_a$pbsum
```

### Obtaining reversal trips

```{r}
# Join the purposeID in reverse direction
dfHomeBound <- dfHomeBound %>%
  left_join(HB_key,
            by = c("Origin_Purpose" = "Destination_Purpose",
                   "Destination_Purpose" = "Origin_Purpose"))

dfHomeBound <- dfHomeBound %>% 
  left_join(expFactors, by = c("RSI_Site" = "Site"))

dfHomeBound.t <-  dfHomeBound %>%
  left_join(pb_a[,c(1:4,9)], by = c("PurposeID" = "HR",  "TP" = "DR"))

```

```{r}
dfHomeBound.t$Trips <- dfHomeBound.t$pa.cond.b * dfHomeBound.t$Factor
```

Now we follow a similar process as before to create the HBmat.

### Creating the full matrix

The information we want is in the format
TP, Bcat_O, Bcat_D, PurposeID, Vehs. 

```{r}
IBmat2 <- dfHomeBound.t %>%
  group_by(HO,DO,BlackcatOrig,BlackCatDest) %>%
  summarise(Trips = sum(Trips)) %>% ungroup()

IBmat2 <- IBmat2 %>% select(DO,BlackCatDest,BlackcatOrig,HO,Trips) # Reversing the order of the OD

OBmat2 <- dfHomeBound %>%
  group_by(TP,BlackcatOrig,BlackCatDest,PurposeID)%>%
    summarise(trips = sum(Factor)) %>% ungroup()

names(IBmat2) <- names(OBmat2)


OBmat2$Bound <- "Out"
IBmat2$Bound <- "In"

HBmat2 <- rbind(OBmat2,IBmat2)

HBmat2 %>%
  left_join(PID_UC, by = "PurposeID")%>%
  group_by(UC,TP)%>%
  summarise(trips = sum(trips))%>%
  ggplot(aes(x= TP, y= trips, label = round(trips),fill = as.factor(UC))) +
  geom_bar(stat = "identity")+
  geom_text( position = position_stack(vjust = 0.5))+
  ylab("Trips")+ labs(fill='UC')+theme_bw() 



HBmat2 %>%
  left_join(PID_UC, by = "PurposeID")%>%
  group_by(UC,TP,Bound)%>%
  summarise(trips = sum(trips))%>%
  ggplot(aes(x= TP, y= trips, label = round(trips),fill = as.factor(UC))) +
  geom_bar(stat = "identity")+
  geom_text( position = position_stack(vjust = 0.5))+
  facet_wrap(~Bound)+
  ylab("Trips")+ labs(fill='UC')+theme_bw()+
  ggtitle("RSI matrix reversal of Out by UC and TP", subtitle = "Home Bound trips - using reversed probablities")

ggsave("./figs/reversal_outbound_HR.pdf",  units = "cm", height = 14.8, width = 21)
```

## NHB trips

There are a number of observations in NHB purposes crossing the cordon. Its difficult to asses if there are corresponding return trips intro the St albans coordon but it is safe to assume that most of the trips will return in the same TP

We then expand and reverse the nhb data
```{r}
dfNHB <- dfNHB %>% 
  left_join(expFactors, by = c("RSI_Site" = "Site")) %>% ungroup()

nhb_rev <- dfNHB %>%
  select(BlackCatDest,BlackcatOrig,TP,Factor)

dfNHB <- dfNHB %>%
  select(BlackcatOrig,BlackCatDest,TP,Factor)

names(nhb_rev) <- names(dfNHB)

dfNHB <- rbind(dfNHB,nhb_rev)


nhbMat <- dfNHB %>%
  group_by(TP,BlackcatOrig,BlackCatDest) %>%
  summarise(trips = sum(Factor))

nhbMat$UC <- 3

```

## Matrix build NHB + Home Bound and Home outbound

We need to make the variable names consistent and then add them up by OD.

```{r}
HBmat$Bound <- HBmat2$Bound <- NULL # remove direction

nhbMat <- nhbMat %>%
  select(TP, BlackcatOrig,BlackCatDest,UC,trips) #Purpose ID 3 and UC 3 correspond to each other so no further modification needs to be done.

names(nhbMat) <- names(HBmat)

nhbMat <- nhbMat %>% ungroup()

#Bind them together
stMatrix <- rbind(HBmat,HBmat2,nhbMat)

# Add UC info

stMatrix <- stMatrix %>%
  left_join(PID_UC, by = "PurposeID")%>%
  group_by(TP,UC,BlackcatOrig,BlackCatDest) %>%
  summarise(flow = sum(trips)) %>% ungroup()

```

Some checks in form of plots

```{r}
stMatrix %>%
  group_by(UC,TP)%>%
  summarise(flow = sum(flow))%>%
  ggplot(aes(x= TP, y= flow, label = round(flow),fill = as.factor(UC))) +
  geom_bar(stat = "identity")+
  geom_text( position = position_stack(vjust = 0.5))+
  ylab("Trips")+ labs(fill='UC')+ theme_bw() + ggtitle("St Neots RSI matrix", subtitle = "12h level")

ggsave("./figs/RSI_matrix_dissagg_UC_TP.pdf", units = "cm", height = 14.8, width = 21)
```


```{r}
sum(stMatrix$flow)
```


## Output of the matrices

## Add the zeroes

```{r}
fullMatrix <- as.tibble(fread("./data/Full_matrix.TXT"))
```

First we add a version without zeroes

```{r}
#Version without zeroes
for (tp in (1:3)){
  for (uc in (1:3)){
    write_csv(stMatrix[stMatrix$TP == tp & stMatrix$UC == uc,], path = paste0("./output/matrices/RSI_Car_UC",uc,"_TS",tp))
  }
}
```

