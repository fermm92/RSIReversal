---
title: "RSI reversal notebook"
author: "Fernando Munoz"
output:
  html_notebook:
    highlight: default
    fig_retina: 2
    code_folding: show
    number_sections: no
    theme: flatly
    toc: yes
    toc_float: yes
---


```{r init stuff, message=FALSE, warning=FALSE, include=FALSE}

## Required packages
source("./configuration/requirements.R")

## Functions needed
source("./R/functions.R")


## Project settings
source("./Configuration/project_settings.R")
```

##Intro
This notebook reverses the data from the RSIs. For that we need to divides= it by userclas (bussiness, commuting, other, (maybe more as it matches up with the tempro data) LGV, HGV) and Time Period. 

The trip porpuse can be obtained from a combination of origin purpose and destination purpose.

## Data
Tempro data set probablity table
RSI table from excel (pre-process to be done)

### Import the data
```{r}
df <- as.tibble(fread("./data/RSI_data.csv"))
```

We can see that there are 21 different combinations of HB trips (starting from home) but NTS data only contemplates 18 different purposes from wich only 8 are HBased. Therefore a correspondence table will be created in Excel.
```{r}
unique(df[
  (df$Origin_Purpose == "HOME"),
  c("Origin_Purpose","Destination_Purpose")])
```
### Match up the trip Purposes
```{r}
#Write the table to csv in outputs
fwrite(unique(df[
  (df$Origin_Purpose == "HOME"),
  c("Origin_Purpose","Destination_Purpose")]), "./data/HB_purposes_RSI.csv")
```

The results of the match up are:

```{r}
HB_key <- as.tibble(fread("./data/HB_purposes_RSI_correspondence.csv")) 
HB_key
```

The tempro table is

```{r}
as.tibble(fread("./data/tblLookUpTripPurpose.csv")) 
```

The opposite trips have the same purposes but reversed:
```{r}
unique(df[
  (df$Destination_Purpose == "HOME"),
  c("Origin_Purpose","Destination_Purpose")])
```

### Match up the time periods

Our data has 3 time periods AM, IP, PM this is equivalent with TEMPRO's time periods 1,2,3 so a match up is not needed.

We create an hour column in the data by spliting the time column on the ":" we can see the last two columns have our created data

```{r}
df$hour <-  as.numeric(str_split_fixed(df$Time,pattern = ":", 2)[,1])
df$TP <- ConvertHourtoTP(df$hour)
```


### Filtering data

We have a set of different RSIs in different locations but we want only the ones that are in St Neots
```{r}
unique(df$RSI_Site)
```

```{r}
df <- df %>%
  filter(str_detect(RSI_Site,pattern = "StNeots"))
```

We also remove non homebased and freight into separate data frames as we are going to process them differently.

```{r}
dfHomeBound <- df[df$Destination_Purpose == "HOME",]
dfNHB <- df[df$Destination_Purpose != "HOME" & df$Origin_Purpose != "HOME",]

df <- df[df$Origin_Purpose == "HOME",]

```


To this data base we can `join` the trip purpose:

```{r}
df <- df %>%
  left_join(HB_key, by = c("Origin_Purpose","Destination_Purpose"))

df
```

### Read the tempro data

```{r}
phi <-  as.tibble(fread("./data/tblTripProbabilities.csv")) 
phi <- phi[phi$PHI>0,] # Remove 0 values
phi
```

In this table the O denotes Origin and R return, H is the purpose and D is the time period. 
We filter the data to remove unused timeperiods.

```{r}
phi <- phi %>%
  filter(DR %in% c(1:3) & DO %in% c(1:3))
```

